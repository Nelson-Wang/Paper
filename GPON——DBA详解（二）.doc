在GPON——DBA详解一文中，对DBA的概念以及作用进行了介绍，并同时提供了一个较为简单的流量计算方法。本文将进一步对DBA进行解析，并介绍在实际使用中，为了能够让流量分配的更加精确，带宽利用率，吞吐率较高，而引入的一系列方法。

 

1、 DBA周期

前文说过，在PON协议中，一帧为125us，ONU每帧会上报DBRu信息，告诉DBA我目前有多少数据在缓存里等着你给我带宽来上送。理想情况下如果DBA算的足够快，我们希望每个125usDBA都能基于DBRu信息来计算出该TCONT需要多少带宽。但当我们算法较为复杂时，我们可能需要牺牲实时性来保证我们的运算结果的准确性，因而引入周期的概念。

即DBA会收集N帧内的所有DBRu信息（N即为DBA周期），基于这一段时间内的所有信息，计算出之后N帧的带宽分配结果并下发

由此可见，引入周期的概念后，我们计算的结果将更加精确：

1）一帧内的最大可用带宽为19440*N

2）运算时间变为125us*N，可以进行多轮迭代

但同时

       1）引入的时延变大，125us*3*N   需要三个周期（收集/计算/下发）

       2）DBA灵敏度降低——一个周期内下发的带宽不会变化

 

2、 单帧分配和多帧分配

首先介绍一下GPON协议上行相关的概念：

下图是GPON中上行GTC帧的帧结构 




ONU向OLT发送上行帧时，需要发送一个前导码+定界符的填充序列，OLT会在一个范围内滑窗查询固定内容的定界符，从而找到上行帧头的起始位置，从而开始接收数据。而对于DBA来说，DBA下发的bwmap中starttime和stoptime所限定的时隙是不包含PLOu域的，即从一个上行GTC帧的PLOAMu/DBRu域开始的。所以DBA在分配带宽时，对于不同的传输突发（BURST）需要在前一个stoptime和starttime之间预留一些时间（GAP）

上行FEC校验示意图如下图所示：




当ONU使能FEC校验功能后，会对上行帧数据进行（239，255）FEC编码，对于DBA来说在分配带宽的时候也需要考虑到FEC校验码所占用的时隙，必须确保分配的时隙足够大让ONU能够完整的上报FEC校验码，因此在使能上行FEC校验功能时，DBA的每条bwmap的stoptime不能够落在R域上，如下图所示




 

下面言归正传，引入周期的概念后，当周期为N（N>1）时，在某些TCONT所承载的业务实时性要求不是特别高的时候，若该TCONT仅需要2000字节的带宽，那么我们完全不需要将其平均分到每一帧分N个传输突发来发送，完全可以在一帧中使用一个传输突发将2000字节完全发完。如果这样的话，就可以由N个突发减少到1个突发，节约（N-1）个GAP的带宽，同时在上行FEC使能时，可以节约若干个FEC校验码块的带宽，较大的提高带宽利用率。因此我们引入单帧分配与多帧分配的概念：

1）单帧分配：将DBA计算的带宽结果平均分配到周期N内的每一帧，分N个传输突发进行发送，确保每一帧都能够分配到带宽

2）多帧分配：不承诺每帧都能分配到带宽，DBA计算的带宽结果将在一个DBA周期内下发完毕

 

由上述对比可见，多帧分配虽然能够节约带宽，提高带宽利用率，但相较于但真分配牺牲了带宽的实时性。

 

在实际应用中，我们希望当带宽很紧张时，优先确保带宽的利用率，让ONU缓存中的报文尽可能的发送出来，因此我们引入了一个单帧转多帧（FEC回收）的功能：

即在NAB/BE两种非确保带宽迭代竞争时，若剩余可用的带宽不足时，我们可以将一些单帧分配的TCONT暂时切换到多帧分配，从而能够回收若干的GAP以及FEC带宽，将回收回来的带宽应用于目前的非确保带宽竞争中，尽最大可能的减少不必要的GAP与FEC开销，提高带宽利用率
